<!doctype html><html class=html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Image Hosting Service and How to implement MVC-ish architecture in Cloudflare Workers | Thirafi Dev Logs</title>
<link rel=icon href=/favicon.ico><meta name=description content="A writeup of my Image Hosting Service project"><meta property="og:url" content="https://blog.naj.one/posts/image-hosting-service-writeup/"><meta property="og:site_name" content="Thirafi Dev Logs"><meta property="og:title" content="Image Hosting Service and How to implement MVC-ish architecture in Cloudflare Workers"><meta property="og:description" content="A writeup of my Image Hosting Service project"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-18T14:10:32+07:00"><meta property="article:modified_time" content="2023-08-18T14:10:32+07:00"><meta property="article:tag" content="Serverless"><meta property="article:tag" content="Cloudflare"><meta itemprop=name content="Image Hosting Service and How to implement MVC-ish architecture in Cloudflare Workers"><meta itemprop=description content="A writeup of my Image Hosting Service project"><meta itemprop=datePublished content="2023-08-18T14:10:32+07:00"><meta itemprop=dateModified content="2023-08-18T14:10:32+07:00"><meta itemprop=wordCount content="880"><meta itemprop=keywords content="Serverless,Cloudflare"><link rel=stylesheet href=/css/style.min.b7bdb5b68f9542b0a57f52f983d331457d8ec810d72fb016ad8a088f4dd4e11b.css integrity="sha256-t721to+VQrClf1L5g9MxRX2OyBDXL7AWrYoIj03U4Rs=" crossorigin=anonymous></head><body class=body><header class=header><h1>Thirafi Dev Logs</h1><nav class="menu language"><ul class="menu__list language__list"><li class=menu__item><a class=menu__link href=/>Home</a></li><li class=menu__item><a class=menu__link href=/about/>About</a></li><li class=menu__item><a class=menu__link href=/posts/>Posts</a></li><li class=menu__item><a class=menu__link href=/categories/>Categories</a></li><li class=menu__item><a class=menu__link href=/tags/>Tags</a></li></ul></nav></header><main class=main><h1>Image Hosting Service and How to implement MVC-ish architecture in Cloudflare Workers</h1><span class=author>Thirafi Najwan</span><br><time class=published-date datetime=2023-08-18T14:10:32+07:00>2023-08-18</time><details class=details-table-of-contents open><summary>Table of Contents</summary><nav id=TableOfContents><ul><li><a href=#but-why>But Why?</a><ul><li><a href=#the-problem>The Problem</a></li></ul></li></ul><ul><li><a href=#disclaimer>Disclaimer</a></li><li><a href=#the-idea>The Idea</a></li><li><a href=#elephant-in-the-room>Elephant in the Room</a></li></ul></nav></details><p>in this post, I will try to explain my own interpretation of MVC architecture and how I implement it in my Cloudflare Workers project. I&rsquo;ll be using my Image Hosting Service project as an example. This project will be fully hosted on <strong>Cloudflare Workers</strong> and <strong>Cloudflare R2</strong>. No static hosting is used.</p><h2 class=heading id=but-why>But Why?<span class=heading__anchor> <a href=#but-why>#</a></span></h2><p>NodeJS is my go-to stack when developing websites; I typically use React for the front-end and Express for the back-end REST API. But when I had to use the MVC framework Django to create a web application for my internship, I fell in love with it right away.</p><p>However, working with Python can feel a bit &ldquo;magical&rdquo; in a bad way because of its dynamic nature. Built-in arguments frequently lack typehints, and Django ORM methods and arguments are difficult to comprehend without spending a lot of time reading through the documentation and source code. Additionally, Django did not perform well with method completion. All these issues are resolved by TypeScript.</p><p>As a result, I tried right away to implement MVC using NodeJS and the Express library using EJS. That stack performed flawlessly throughout. It works up until the point where you try to implement it using serverless.</p><h3 class=heading id=the-problem>The Problem<span class=heading__anchor> <a href=#the-problem>#</a></span></h3><p>Workers cannot be effectively used with EJS because of its close relationship to NodeJS functions. Mainly, the ability to do an evaluation function is not supported. So, after doing extensive research, I discovered two potential solutions for EJS replacement in workers. That is:</p><ol><li>Use the HTMLRewriter class and webpack (which is supported by default) to load HTML and add dynamic content, or</li><li>Create the HTML manually using template literals and return it with the necessary headers.</li></ol><p>The issue with the first method is that I have a really difficult time configuring Webpack in Workers because serverless cannot access filesystem functionality. Aside from that, compared to another MVC framework that I am already familiar with, using HTMLRewrite to inject a dynamic value seems a little counterintuitive even if I can get it to work. So I chose the latter.</p><h1 class=heading id=solution>Solution<span class=heading__anchor> <a href=#solution>#</a></span></h1><h2 class=heading id=disclaimer>Disclaimer<span class=heading__anchor> <a href=#disclaimer>#</a></span></h2><p>I won&rsquo;t go deep to how my image hosting services work, because it really is just a simple listen to POST request with <code>multipart/form-data;</code> and upload it to R2 bucket. You can find the source code in <a href=https://github.com/reverseon/img.thr.fi>GitHub</a> if you want to look closer.</p><h2 class=heading id=the-idea>The Idea<span class=heading__anchor> <a href=#the-idea>#</a></span></h2><p>The idea is simple, it is expanded on this Workers <a href=https://developers.cloudflare.com/workers/examples/return-html/>example</a>. So, you can return an HTML page with this code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Response</span>(<span style=color:#a6e22e>html_string</span>, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Content-Type&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;text/html; charset=UTF-8&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>The next logical question is then, how to pass a dynamic variable and inject it to an HTML string? My solution is to use javascript template literals for this. The one with <code>${}</code> syntax.</p><p>For example, if i want to display dynamic heading, I first create a function that constructs a desired HTML strings from given arguments. For example.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>index__html</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>ctx</span>: <span style=color:#66d9ef>any</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;h1&gt;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>title</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&lt;/h1&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    `</span>
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>and then, you can return that page by using this syntax in your workers.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Response</span>(<span style=color:#a6e22e>index__html</span>(
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Dynamic Heading&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Content-Type&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;text/html; charset=UTF-8&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>));
</span></span></code></pre></div><p>Looks a lot more like Django or Laravel, doesn&rsquo;t it? With template literals, you can expand almost any basic features in MVC templating engine. For loop? just make a function that construct the desired string using for-loop and call it inside template literals. Include? make a function that returns included HTML strings and call that function inside string literals. Just be careful with your function namings to prevent confusion.</p><h2 class=heading id=elephant-in-the-room>Elephant in the Room<span class=heading__anchor> <a href=#elephant-in-the-room>#</a></span></h2><p>Ok, this works with HTML or any string-based content. Then, how about assets serving that requires bytestream, for example, images? Workers doesn&rsquo;t have access to filesystem, so static serving router that utilizes something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#66d9ef>get</span>(<span style=color:#e6db74>&#39;/:filename&#39;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>ctx</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Response</span>(<span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>arrayBuffer</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>filename</span>))
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>cannot work. My own band-aid solution is to utilize base64 representation since it is already a string. This may be inefficient, but I can&rsquo;t think of any better solution at the time of this writing.</p><p>For example, if you want to serve <code>image.jpg</code> in route <code>/static/img/</code>, you can first create a function that returns the base64 representation of the image. i.e.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>image__jpg</span> <span style=color:#f92672>=</span> ()<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    // base64 here
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    `</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>and then, in your router, you can hard-code the endpoint to match the name of the file (or not, its entirely up to you) and then return the byte-converted value and set the appropriate headers like this.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#66d9ef>get</span>(<span style=color:#e6db74>&#39;/img/image.jpg&#39;</span>, <span style=color:#66d9ef>async</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>Request</span>, <span style=color:#a6e22e>env</span>: <span style=color:#66d9ef>Env</span>, <span style=color:#a6e22e>ctx</span>: <span style=color:#66d9ef>ExecutionContext</span>
</span></span><span style=display:flex><span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>base64</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>image__jpg</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bytes</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Uint8Array</span>.<span style=color:#66d9ef>from</span>(<span style=color:#a6e22e>atob</span>(<span style=color:#a6e22e>base64</span>), <span style=color:#a6e22e>c</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>charCodeAt</span>(<span style=color:#ae81ff>0</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Response</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bytes</span>, {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;image/jpeg&#39;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;Content-Length&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>length</span>.<span style=color:#a6e22e>toString</span>(),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;Content-Disposition&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;inline; filename=&#34;image.jpg&#34;&#39;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;Cache-Control&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;public, max-age=31536000&#39;</span>,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h1 class=heading id=conclusion>Conclusion<span class=heading__anchor> <a href=#conclusion>#</a></span></h1><p>To sum up, this might be a really hacky and inefficient way to implement MVC-ish architecture in a serverless environment. Of course there is a tradeoff by using serverless. For example, you need to rely on Cloudflare&rsquo;s rate-limiting to rate limit the API, and it&rsquo;s hard to create CSRF token without delving deep into storage medium like KV and it&rsquo;s synchronization problem. But overall, it&rsquo;s a project well(-enough) done, and I&rsquo;m proud of it.</p><div><div>Tags:</div><ul><li><a href=/tags/serverless/>Serverless</a></li><li><a href=/tags/cloudflare/>Cloudflare</a></li></ul></div><div><div>Categories:</div><ul><li><a href=/categories/project/>Project</a></li></ul></div><nav class=page-nav><a href=/posts/url-shortener-writeup/>Next: My URL Shortener (thr.fi) Project Writeup</a></nav></main><footer class=footer><p class=footer__copyright-notice>&copy; 2024</p><p class=footer__theme-info>Built with <a href=https://gohugo.io>Hugo</a> and <a href=https://github.com/CyrusYip/hugo-theme-yue>Yue</a></p></footer></body></html>